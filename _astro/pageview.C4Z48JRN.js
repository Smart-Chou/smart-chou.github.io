const $={"Content-Type":"application/json"},m=e=>`${e.replace(/\/?$/,"/")}api/`,y=(e,t="")=>{if(typeof e=="object"&&e.errno)throw new TypeError(`${t} failed with ${e.errno}: ${e.errmsg}`);return e},f=({serverURL:e,lang:t,paths:r,type:a,signal:o})=>fetch(`${m(e)}article?path=${encodeURIComponent(r.join(","))}&type=${encodeURIComponent(a.join(","))}&lang=${t}`,{signal:o}).then(n=>n.json()).then(n=>y(n,"Get counter").data),U=({serverURL:e,lang:t,path:r,type:a,action:o})=>fetch(`${m(e)}article?lang=${t}`,{method:"POST",headers:$,body:JSON.stringify({path:r,type:a,action:o})}).then(n=>n.json()).then(n=>y(n,"Update counter").data),R=({serverURL:e,lang:t,paths:r,signal:a})=>f({serverURL:e,lang:t,paths:r,type:["time"],signal:a}),v=e=>U({...e,type:"time",action:"inc"}),w=(e="")=>e.replace(/\/$/u,""),b=e=>/^(https?:)?\/\//.test(e),g=e=>{const t=w(e);return b(t)?t:`https://${t}`},L=e=>{e.name!=="AbortError"&&console.error(e.message)},u=e=>{const{path:t}=e.dataset;return t!=null&&t.length?t:null},d=(e,t)=>{t.forEach((r,a)=>{const o=e[a].time;typeof o=="number"&&(r.innerText=o.toString())})},j=({serverURL:e,path:t=window.location.pathname,selector:r=".waline-pageview-count",update:a=!0,lang:o=navigator.language})=>{const n=new AbortController,i=Array.from(document.querySelectorAll(r)),c=s=>{const l=u(s);return l!==null&&t!==l},h=s=>R({serverURL:g(e),paths:s.map(l=>u(l)??t),lang:o,signal:n.signal}).then(l=>d(l,s)).catch(L);if(a){const s=i.filter(p=>!c(p)),l=i.filter(c);v({serverURL:g(e),path:t,lang:o}).then(p=>d(p,s)),l.length&&h(l)}else h(i);return n.abort.bind(n)};export{j as S};
